import{I as K,g as Q,a as $,c as J,T as ue,i as Z,b as g,d as O,e as y,r as ge,l as le,E as ee,u as de,f as me,S as _e,h as Ie,j as q,k as fe,m as G,n as j,o as te,B as Ee,p as P,q as se,s as Y,t as k,v as Re,L as pe,C as Se,w as V,x as B,y as Oe,z as ye,A as X,D as Ae,F as xe,G as Le}from"./Layer-CXuXWfn4.js";function ne(n,e){const t=(""+n).split("."),i=(""+e).split(".");for(let s=0;s<Math.max(t.length,i.length);s++){const r=parseInt(t[s]||"0",10),a=parseInt(i[s]||"0",10);if(r>a)return 1;if(a>r)return-1}return 0}function C(n){return Array.isArray(n)?Math.min(...n):n}class Te extends K{constructor(e,t,i,s,r,a,o){let c=e.getExtent();c&&e.canWrapX()&&(c=c.slice(),c[0]=-1/0,c[2]=1/0);let u=t.getExtent();u&&t.canWrapX()&&(u=u.slice(),u[0]=-1/0,u[2]=1/0);const h=u?Q(i,u):i,l=$(h),f=J(e,t,l,s),A=me,x=new ue(e,t,h,c,f*A,s),L=x.calculateSourceExtent(),_=Z(L)?null:a(L,f,r),T=_?g.IDLE:g.EMPTY,v=_?_.getPixelRatio():1;super(i,s,v,T),this.targetProj_=t,this.maxSourceExtent_=c,this.triangulation_=x,this.targetResolution_=s,this.targetExtent_=i,this.sourceImage_=_,this.sourcePixelRatio_=v,this.interpolate_=o,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==g.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){const e=this.sourceImage_.getState();if(e==g.LOADED){const t=O(this.targetExtent_)/this.targetResolution_,i=y(this.targetExtent_)/this.targetResolution_;this.canvas_=ge(t,i,this.sourcePixelRatio_,C(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_,!0)}this.state=e,this.changed()}load(){if(this.state==g.IDLE){this.state=g.LOADING,this.changed();const e=this.sourceImage_.getState();e==g.LOADED||e==g.ERROR?this.reproject_():(this.sourceListenerKey_=le(this.sourceImage_,ee.CHANGE,function(t){const i=this.sourceImage_.getState();(i==g.LOADED||i==g.ERROR)&&(this.unlistenSource_(),this.reproject_())},this),this.sourceImage_.load())}}unlistenSource_(){de(this.sourceListenerKey_),this.sourceListenerKey_=null}}const m=4,N={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"};class ve extends Ee{constructor(e,t){super(e),this.image=t}}class we extends _e{constructor(e){super({attributions:e.attributions,projection:e.projection,state:e.state,interpolate:e.interpolate!==void 0?e.interpolate:!0}),this.on,this.once,this.un,this.loader=e.loader||null,this.resolutions_=e.resolutions!==void 0?e.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=e.loader?e.loader.length===0:!1,this.wantedProjection_=null}getResolutions(){return this.resolutions_}setResolutions(e){this.resolutions_=e}findNearestResolution(e){const t=this.getResolutions();if(t){const i=Ie(t,e,0);e=t[i]}return e}getImage(e,t,i,s){const r=this.getProjection();if(!r||!s||q(r,s))return r&&(s=r),this.getImageInternal(e,t,i,s);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&q(this.reprojectedImage_.getProjection(),s)&&this.reprojectedImage_.getResolution()==t&&fe(this.reprojectedImage_.getExtent(),e))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new Te(r,s,e,t,i,(a,o,c)=>this.getImageInternal(a,o,c,r),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(e,t,i,s){if(this.loader){const r=ie(e,t,i,1),a=this.findNearestResolution(t);if(this.image&&(this.static_||this.wantedProjection_===s&&(this.wantedExtent_&&G(this.wantedExtent_,r)||G(this.image.getExtent(),r))&&(this.wantedResolution_&&C(this.wantedResolution_)===a||C(this.image.getResolution())===a)))return this.image;this.wantedProjection_=s,this.wantedExtent_=r,this.wantedResolution_=a,this.image=new K(r,a,i,this.loader),this.image.addEventListener(ee.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(e){const t=e.target;let i;switch(t.getState()){case g.LOADING:this.loading=!0,i=N.IMAGELOADSTART;break;case g.LOADED:this.loading=!1,i=N.IMAGELOADEND;break;case g.ERROR:this.loading=!1,i=N.IMAGELOADERROR;break;default:return}this.hasListener(i)&&this.dispatchEvent(new ve(i,t))}}function je(n,e){n.getImage().src=e}function ie(n,e,t,i){const s=e/t,r=$(n),a=j(O(n)/s,m),o=j(y(n)/s,m),c=j((i-1)*a/2,m),u=a+2*c,h=j((i-1)*o/2,m),l=o+2*h;return te(r,s,0,[u,l])}function re(n,e){const t=[];Object.keys(e).forEach(function(s){e[s]!==null&&e[s]!==void 0&&t.push(s+"="+encodeURIComponent(e[s]))});const i=t.join("&");return n=n.replace(/[?&]$/,""),n+=n.includes("?")?"&":"?",n+i}const ae="1.3.0",z=[101,101];function oe(n,e,t,i,s){s.WIDTH=t[0],s.HEIGHT=t[1];const r=i.getAxisOrientation();let a;const o=ne(s.VERSION,"1.3")>=0;return s[o?"CRS":"SRS"]=i.getCode(),o&&r.substr(0,2)=="ne"?a=[e[1],e[0],e[3],e[2]]:a=e,s.BBOX=a.join(","),re(n,s)}function Pe(n,e,t,i,s,r,a){r=Object.assign({REQUEST:"GetMap"},r);const o=e/t,c=[k(O(n)/o,m),k(y(n)/o,m)];if(t!=1)switch(a){case"geoserver":const h=90*t+.5|0;"FORMAT_OPTIONS"in r?r.FORMAT_OPTIONS+=";dpi:"+h:r.FORMAT_OPTIONS="dpi:"+h;break;case"mapserver":r.MAP_RESOLUTION=90*t;break;case"carmentaserver":case"qgis":r.DPI=90*t;break;default:throw new Error("Unknown `serverType` configured")}return oe(s,n,c,i,r)}function ce(n,e){return Object.assign({REQUEST:e,SERVICE:"WMS",VERSION:ae,FORMAT:"image/png",STYLES:"",TRANSPARENT:!0},n)}function Me(n){const e=n.hidpi===void 0?!0:n.hidpi,t=P(n.projection||"EPSG:3857"),i=n.ratio||1.5,s=n.load||se;return(r,a,o)=>{r=ie(r,a,o,i),o!=1&&(!e||n.serverType===void 0)&&(o=1);const c=Pe(r,a,o,t,n.url,ce(n.params,"GetMap"),n.serverType),u=new Image;return n.crossOrigin!==null&&(u.crossOrigin=n.crossOrigin),s(u,c).then(h=>({image:h,extent:r,pixelRatio:o}))}}function be(n,e,t){if(n.url===void 0)return;const i=P(n.projection||"EPSG:3857"),s=te(e,t,0,z),r={QUERY_LAYERS:n.params.LAYERS,INFO_FORMAT:"application/json"};Object.assign(r,ce(n.params,"GetFeatureInfo"),n.params);const a=Y((e[0]-s[0])/t,m),o=Y((s[3]-e[1])/t,m),c=ne(r.VERSION,"1.3")>=0;return r[c?"I":"X"]=a,r[c?"J":"Y"]=o,oe(n.url,s,z,i,r)}function De(n,e){if(n.url===void 0)return;const t={SERVICE:"WMS",VERSION:ae,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(n.params===void 0||n.params.LAYER===void 0){const i=n.params.LAYERS;if(!(!Array.isArray(i)||i.length===1))return;t.LAYER=i}if(e!==void 0){const i=P(n.projection||"EPSG:3857").getMetersPerUnit()||1,s=28e-5;t.SCALE=e*i/s}return Object.assign(t,n.params),re(n.url,t)}class Fe extends we{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:je,this.params_=e.params,this.serverType_=e.serverType,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getFeatureInfoUrl(e,t,i,s){const r=P(i),a=this.getProjection();a&&a!==r&&(t=J(a,r,e,t),e=Re(e,r,a));const o={url:this.url_,params:{...this.params_,...s},projection:a||r};return be(o,e,t)}getLegendUrl(e,t){return De({url:this.url_,params:{...this.params_,...t}},e)}getParams(){return this.params_}getImageInternal(e,t,i,s){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==s)&&(this.loaderProjection_=s,this.loader=Me({crossOrigin:this.crossOrigin_,params:this.params_,projection:s,serverType:this.serverType_,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(r,a)=>(this.image.setImage(r),this.imageLoadFunction_(this.image,a),se(r))})),super.getImageInternal(e,t,i,s))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}const He=Fe;class Ne extends pe{constructor(e){e=e||{},super(e)}}class Ge extends Se{constructor(e){super(e),this.image_=null}getImage(){return this.image_?this.image_.getImage():null}prepareFrame(e){const t=e.layerStatesArray[e.layerIndex],i=e.pixelRatio,s=e.viewState,r=s.resolution,a=this.getLayer().getSource(),o=e.viewHints;let c=e.extent;if(t.extent!==void 0&&(c=Q(c,V(t.extent,s.projection))),!o[B.ANIMATING]&&!o[B.INTERACTING]&&!Z(c))if(a){const u=s.projection,h=a.getImage(c,r,i,u);h&&(this.loadImage(h)?this.image_=h:h.getState()===g.EMPTY&&(this.image_=null))}else this.image_=null;return!!this.image_}getData(e){const t=this.frameState;if(!t)return null;const i=this.getLayer(),s=Oe(t.pixelToCoordinateTransform,e.slice()),r=i.getExtent();if(r&&!ye(r,s))return null;const a=this.image_.getExtent(),o=this.image_.getImage(),c=O(a),u=Math.floor(o.width*((s[0]-a[0])/c));if(u<0||u>=o.width)return null;const h=y(a),l=Math.floor(o.height*((a[3]-s[1])/h));return l<0||l>=o.height?null:this.getImageData(o,u,l)}renderFrame(e,t){const i=this.image_,s=i.getExtent(),r=i.getResolution(),[a,o]=Array.isArray(r)?r:[r,r],c=i.getPixelRatio(),u=e.layerStatesArray[e.layerIndex],h=e.pixelRatio,l=e.viewState,f=l.center,A=l.resolution,x=h*a/(A*c),L=h*o/(A*c),_=e.extent,T=l.resolution,v=l.rotation,E=Math.round(O(_)/T*h),R=Math.round(y(_)/T*h);X(this.pixelTransform,e.size[0]/2,e.size[1]/2,1/h,1/h,v,-E/2,-R/2),Ae(this.inversePixelTransform,this.pixelTransform);const M=xe(this.pixelTransform);this.useContainer(t,M,this.getBackground(e));const d=this.context,I=d.canvas;I.width!=E||I.height!=R?(I.width=E,I.height=R):this.containerReused||d.clearRect(0,0,E,R);let b=!1,D=!0;if(u.extent){const S=V(u.extent,l.projection);D=Le(S,e.extent),b=D&&!G(S,e.extent),b&&this.clipUnrotated(d,e,S)}const p=i.getImage(),w=X(this.tempTransform,E/2,R/2,x,L,0,c*(s[0]-f[0])/a,c*(f[1]-s[3])/o);this.renderedResolution=o*h/c;const U=p.width*w[0],H=p.height*w[3];if(this.getLayer().getSource().getInterpolate()||(d.imageSmoothingEnabled=!1),this.preRender(d,e),D&&U>=.5&&H>=.5){const S=w[4],he=w[5],F=u.opacity;let W;F!==1&&(W=d.globalAlpha,d.globalAlpha=F),d.drawImage(p,0,0,+p.width,+p.height,S,he,U,H),F!==1&&(d.globalAlpha=W)}return this.postRender(d,e),b&&d.restore(),d.imageSmoothingEnabled=!0,M!==I.style.transform&&(I.style.transform=M),this.container}}class Ce extends Ne{constructor(e){super(e)}createRenderer(){return new Ge(this)}getData(e){return super.getData(e)}}const We=Ce;export{We as I,He as a};
//# sourceMappingURL=Image-D0x54Wxr.js.map
